<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('../partials/head') %>
    <title>Novo Gasto - Finansave</title>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container py-4">
        <div class="form-container">
            <div class="form-header">
                <h1 class="h3 mb-0">
                    <i class="fas fa-shopping-cart text-danger"></i>
                    ğŸ’¸ Novo Gasto
                </h1>
                <p class="text-muted mb-0">Registre seus gastos de forma rÃ¡pida e organizada</p>
            </div>

            <%- include('../partials/messages') %>

            <form action="/gastos/criar" method="POST" class="needs-validation" novalidate>
                <!-- Conta -->
                <div class="mb-3">
                    <p class="form-question">ğŸ’³ De qual conta sair o dinheiro?</p>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-credit-card icon-input"></i>
                        <select class="form-control" id="conta_id" name="conta_id" required>
                            <option value="" disabled selected>Selecione uma conta</option>
                            <% contas.forEach(function(conta) { %>
                                <option value="<%= conta.conta_id %>" 
                                        data-saldo="<%= conta.saldo_atual %>"
                                        <%= (typeof req !== 'undefined' && req.body && req.body.conta_id == conta.conta_id) ? 'selected' : '' %>>
                                    <%= conta.nome %> - Saldo: R$ <%= parseFloat(conta.saldo_atual).toFixed(2).replace('.', ',') %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                </div>

                <!-- InformaÃ§Ãµes da conta selecionada -->
                <div id="contaInfo" class="card-info" style="display: none;">
                    <div class="row">
                        <div class="col-md-12">
                            <small class="text-muted">ğŸ’° Saldo disponÃ­vel:</small><br>
                            <span id="saldoDisponivel" class="text-success"></span>
                        </div>
                    </div>
                </div>

                <!-- DescriÃ§Ã£o -->
                <div class="mb-3">
                    <p class="form-question">ğŸ“ O que vocÃª comprou ou pagou?</p>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-edit icon-input"></i>
                        <input type="text" class="form-control" id="descricao" name="descricao" 
                               placeholder="Descreva o gasto" 
                               value="<%= (typeof req !== 'undefined' && req.body && req.body.descricao) ? req.body.descricao : '' %>" 
                               required>
                    </div>
                </div>

                <!-- Categoria -->
                <div class="mb-3">
                    <p class="form-question">ğŸ·ï¸ Qual categoria do gasto?</p>
                    <div class="categoria-buttons">
                        <button type="button" class="categoria-btn" data-categoria="AlimentaÃ§Ã£o">
                            <i class="fas fa-utensils"></i> ğŸ½ï¸ AlimentaÃ§Ã£o
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="Transporte">
                            <i class="fas fa-car"></i> ğŸš— Transporte
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="SaÃºde">
                            <i class="fas fa-heartbeat"></i> ğŸ¥ SaÃºde
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="EducaÃ§Ã£o">
                            <i class="fas fa-graduation-cap"></i> ğŸ“š EducaÃ§Ã£o
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="Lazer">
                            <i class="fas fa-gamepad"></i> ğŸ® Lazer
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="Compras">
                            <i class="fas fa-shopping-bag"></i> ğŸ›ï¸ Compras
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="Casa">
                            <i class="fas fa-home"></i> ğŸ  Casa
                        </button>
                        <button type="button" class="categoria-btn" data-categoria="Outros">
                            <i class="fas fa-ellipsis-h"></i> ğŸ”§ Outros
                        </button>
                    </div>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-tag icon-input"></i>
                        <input type="text" class="form-control" id="categoria" name="categoria" 
                               placeholder="Digite uma categoria personalizada" 
                               value="<%= (typeof req !== 'undefined' && req.body && req.body.categoria) ? req.body.categoria : '' %>" 
                               required>
                    </div>
                </div>

                <!-- Valor -->
                <div class="mb-3">
                    <p class="form-question">ğŸ’° Quanto vocÃª gastou?</p>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-coins icon-input"></i>
                        <input type="number" class="form-control" id="valor" name="valor" 
                               step="0.01" placeholder="0,00" min="0.01" 
                               value="<%= (typeof req !== 'undefined' && req.body && req.body.valor) ? req.body.valor : '' %>" 
                               required>
                    </div>
                </div>

                <!-- Data do Gasto -->
                <div class="mb-3">
                    <p class="form-question">ğŸ“… Quando foi o gasto?</p>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-calendar-alt icon-input"></i>
                        <input type="date" class="form-control" id="data_gasto" name="data_gasto" 
                               value="<%= (typeof req !== 'undefined' && req.body && req.body.data_gasto) ? req.body.data_gasto : '' %>" 
                               required>
                    </div>
                </div>

                <!-- ObservaÃ§Ãµes -->
                <div class="mb-4">
                    <p class="form-question">ğŸ“‹ Alguma observaÃ§Ã£o adicional? (opcional)</p>
                    <div class="input-with-icon position-relative">
                        <i class="fas fa-sticky-note icon-input"></i>
                        <textarea class="form-control" id="observacoes" name="observacoes" 
                                  placeholder="ObservaÃ§Ãµes sobre este gasto" style="height: 100px"><%= (typeof req !== 'undefined' && req.body && req.body.observacoes) ? req.body.observacoes : '' %></textarea>
                    </div>
                </div>

                <!-- BotÃµes -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="/gastos/extrato" class="btn btn-outline-secondary me-md-2">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save"></i> Registrar Gasto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Definir data atual como padrÃ£o apenas se nÃ£o houver valor anterior
        const dataGastoInput = document.getElementById('data_gasto');
        if (!dataGastoInput.value) {
            dataGastoInput.valueAsDate = new Date();
        }

        // Mostrar informaÃ§Ãµes da conta selecionada
        document.getElementById('conta_id').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const contaInfoDiv = document.getElementById('contaInfo');
            const saldoDisponivel = document.getElementById('saldoDisponivel');

            if (selectedOption.value) {
                const saldo = parseFloat(selectedOption.dataset.saldo);

                saldoDisponivel.textContent = new Intl.NumberFormat('pt-BR', { 
                    style: 'currency', 
                    currency: 'BRL' 
                }).format(saldo);
                
                contaInfoDiv.style.display = 'block';
            } else {
                contaInfoDiv.style.display = 'none';
            }
        });

        // Trigger change event se jÃ¡ houver uma conta selecionada (em caso de erro)
        const contaSelect = document.getElementById('conta_id');
        if (contaSelect.value) {
            contaSelect.dispatchEvent(new Event('change'));
        }

        // BotÃµes de categoria
        document.querySelectorAll('.categoria-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active de todos os botÃµes
                document.querySelectorAll('.categoria-btn').forEach(b => b.classList.remove('active'));
                
                // Adiciona active ao botÃ£o clicado
                this.classList.add('active');
                
                // Define a categoria no input
                document.getElementById('categoria').value = this.dataset.categoria;
            });
        });

        // Marcar botÃ£o de categoria ativo se jÃ¡ houver valor (em caso de erro)
        const categoriaInput = document.getElementById('categoria');
        if (categoriaInput.value) {
            document.querySelectorAll('.categoria-btn').forEach(btn => {
                if (btn.dataset.categoria === categoriaInput.value) {
                    btn.classList.add('active');
                }
            });
        }

        // ValidaÃ§Ã£o do valor contra saldo disponÃ­vel
        document.getElementById('valor').addEventListener('input', function() {
            const contaSelect = document.getElementById('conta_id');
            const selectedOption = contaSelect.options[contaSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const saldo = parseFloat(selectedOption.dataset.saldo);
                const valor = parseFloat(this.value);
                
                if (valor > saldo) {
                    this.setCustomValidity('Valor excede o saldo disponÃ­vel da conta');
                } else {
                    this.setCustomValidity('');
                }
            }
        });

        // FormataÃ§Ã£o de moeda
        document.getElementById('valor').addEventListener('blur', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    </script>

    <script src="/js/main.js"></script>
</body>
</html>